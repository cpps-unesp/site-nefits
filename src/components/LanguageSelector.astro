---
const supportedLangs = {
  pt: "ğŸ‡§ğŸ‡·",
  en: "ğŸ‡¬ğŸ‡§",
};
---

<div class="relative inline-block text-left">
  <button
    class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-50"
    type="button"
    onclick="document.getElementById('lang-menu').classList.toggle('hidden')"
    id="lang-button"
  >
    <span id="lang-flag">ğŸŒ</span>
  </button>

  <div
    id="lang-menu"
    class="hidden absolute right-0 mt-2 w-40 rounded-md bg-white shadow-lg z-10 ring-1 ring-black ring-opacity-5"
  >
    <div class="py-1">
      <button
        onclick="changeLang('pt')"
        class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100"
      >
        ğŸ‡§ğŸ‡· PortuguÃªs
      </button>
      <button
        onclick="changeLang('en')"
        class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100"
      >
        ğŸ‡¬ğŸ‡§ English
      </button>
    </div>
  </div>
</div>

<script is:inline>
  const supportedLangs = {
    pt: "ğŸ‡§ğŸ‡·",
    en: "ğŸ‡¬ğŸ‡§",
  };

  function updateLangFlag() {
    const parts = window.location.pathname.split("/").filter(Boolean);
    const currentLang = supportedLangs[parts[0]] ? parts[0] : "pt";
    document.getElementById("lang-flag").textContent = supportedLangs[currentLang];
  }

  async function changeLang(lang) {
    localStorage.setItem("language", lang);

    const parts = window.location.pathname.split("/").filter(Boolean);
    const hasLang = Object.keys(supportedLangs).includes(parts[0]);
    const currentSlug = parts.length >= 3 ? parts[2] : null;  // [lang]/noticias/[slug]

    let newPath;

    if (currentSlug) {
      // Estamos numa pÃ¡gina de notÃ­cia individual!
      try {
        const response = await fetch(`/${lang}/noticias/${currentSlug}`);
        if (response.ok) {
          newPath = `/${lang}/noticias/${currentSlug}`; // A notÃ­cia existe no outro idioma
        } else {
          newPath = `/${lang}/noticias`; // NÃ£o existe, volta para a listagem
        }
      } catch (e) {
        newPath = `/${lang}/noticias`; // Em caso de erro, vai para a listagem
      }
    } else {
      // Estamos numa pÃ¡gina normal
      newPath = hasLang
        ? `/${lang}/${parts.slice(1).join("/")}`
        : `/${lang}/${parts.join("/")}`;
    }

    window.location.pathname = newPath;
  }

  updateLangFlag();
</script>
